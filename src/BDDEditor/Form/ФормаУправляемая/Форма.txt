
&НаКлиенте
Процедура ПутьКХранилищуНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	//TODO 
	//Здесь будет выбор места хранения структуры
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВыборФайлаСтруктуры(ВыбранныеФайлы,ДополнительныеПараметры) Экспорт
	Если ВыбранныеФайлы = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	Объект.СтруктураДляЗагрузки=ВыбранныеФайлы[0];
	Если ЗначениеЗаполнено(Объект.СтруктураДляЗагрузки) Тогда
		//ПолучитьСтруктуруКаталогов("СписокКомпонент");
		ПолучитьСтруктуруКаталогов("ОбъемПроекта");
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура СтруктураДляЗагрузкиНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОписаниеОповещения = Вычислить("Новый ОписаниеОповещения(""ОбработатьВыборФайлаСтруктуры"", ЭтаФорма)");
		Выполнить("ДиалогОткрытияФайла.Показать(ОписаниеОповещения)");
	Иначе	
		Если ДиалогОткрытияФайла.Выбрать() Тогда
			Объект.СтруктураДляЗагрузки = ДиалогОткрытияФайла.Каталог;
			Если ЗначениеЗаполнено(Объект.СтруктураДляЗагрузки) Тогда
				//ПолучитьСтруктуруКаталогов("СписокКомпонент");
				ПолучитьСтруктуруКаталогов("ОбъемПроекта");
			КонецЕсли;	
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;
КонецПроцедуры

&НаСервере
Функция ПодключитьВнешнююОбработкуСервер(АдресХранилища)
	Возврат ВнешниеОбработки.Подключить(АдресХранилища,,Ложь); 
КонецФункции 

&НаКлиенте
Процедура ОбработкаПослеПомещенияФайла(Результат,АдресХранилища,ВыбранноеИмяФайла,ДополнительныеПараметры) Экспорт
	ИмяОбработки = ПодключитьВнешнююОбработкуСервер(АдресХранилища);
	ДополнительныеПараметры.Вставить("ИмяОбработки",ИмяОбработки);
КонецПроцедуры

&НаКлиенте
Функция ПодключитьВнешнююОбработкуКлиент(ИмяФайла) Экспорт
	ДополнительныеПараметры = Новый Структура;
	Если ЕстьПоддержкаНемодальныхФорм Тогда
		Оповещение = Вычислить("Новый ОписаниеОповещения(""ОбработкаПослеПомещенияФайла"", ЭтаФорма, ДополнительныеПараметры)");
		Выполнить("НачатьПомещениеФайла(Оповещение,, ИмяФайла, Ложь, УникальныйИдентификатор);");
		
		Возврат ДополнительныеПараметры.ИмяОбработки;
	Иначе
		АдресХранилища = "";
		ПоместитьФайл(АдресХранилища, ИмяФайла, , Ложь, УникальныйИдентификатор);
		//ПодключитьВнешнююОбработку(АдресХранилища);
		Результат = Неопределено;
		ИмяОбработки = ПодключитьВнешнююОбработкуСервер(АдресХранилища);
		Возврат ИмяОбработки;
		
		//ОбработкаПолученияФайлаОбработкиТеста(Результат,АдресХранилища,ИмяФайла,ДополнительныеПараметры);
	КонецЕсли;
КонецФункции 

&НаКлиенте
Процедура СкопироватьДеревоФич(ДеревоТестов)//ДеревоТестов
	//ПрочитатьЗначениеСтрокиДерева(Новый Структура("ДеревоТестов",ДеревоТестов));
	ПрочитатьДеревоФич(Новый Структура("ДеревоТестов",ДеревоТестов));
	
КонецПроцедуры	

&НаСервере
Функция ПрочитатьДеревоФич(СтруктураДерева)
	ДеревоСтруктуры=СтруктураДерева["ДеревоТестов"];
	ДеревоР = РеквизитФормыВЗначение("ДеревоРедактора");
	ДеревоР.Строки.Очистить();
	СтрокаДерева=ДеревоСтруктуры.ПолучитьЭлементы();
	
	ПрочитатьЗначениеСтрокиДерева(СтрокаДерева,ДеревоР.Строки);
	
	ЗначениеВРеквизитФормы(ДеревоР,"ДеревоРедактора");
КонецФункции

&НаСервере
Функция ПрочитатьЗначениеСтрокиДерева(СтрокаДерева,ДеревоР)
	Для Каждого Строка Из СтрокаДерева Цикл

		НовСтр = ДеревоР.Добавить();
		ЗаполнитьЗначенияСвойств(НовСтр,Строка);
		СтрокаДалее=Строка.ПолучитьЭлементы();	
		Если СтрокаДалее.Количество()>0 Тогда
			ПрочитатьЗначениеСтрокиДерева(СтрокаДалее,НовСтр.Строки);
		КонецЕсли;	
		
	КонецЦикла;
	
КонецФункции

&НаСервереБезКонтекста
Функция ПолучитьЗначениеКонстанты(ИмяКонстанты) Экспорт
	ЗначениеКонстанты = Константы[ИмяКонстанты].Получить();
	Возврат ЗначениеКонстанты;
КонецФункции


&НаКлиенте
Процедура ЗаполнитьДерево(Команда) Экспорт
	ИмяОбработки = ПодключитьВнешнююОбработкуКлиент(Объект.ПутьКVanessaBehavior);
	ФормаОбработки = ПолучитьФорму("ВнешняяОбработка." + ИмяОбработки + ".Форма.УправляемаяФорма",,,Истина);
	ФормаОбработки.Объект.КаталогИнструментов = ПолучитьЗначениеКонстанты("ПутьККаталогуИнструментов");
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ПоказатьЗначение(Новый ОписаниеОповещения("ЗаполнитьДеревоЗавершение", ЭтаФорма, Новый Структура("ФормаОбработки", ФормаОбработки)), ФормаОбработки);		
		
	Иначе
		ФормаОбработки.Открыть();
		ФормаОбработки.Объект.КаталогИнструментов=Объект.КаталогИнструментов;
		ФормаОбработки.Объект.КаталогФич = Объект.СтруктураДляЗагрузки;
		ФормаОбработки.ЗагрузитьФичи();
		СкопироватьДеревоФич(ФормаОбработки.Объект.ДеревоТестов);
		ФормаОбработки.Закрыть();
	КонецЕсли;
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьДеревоЗавершение(ДополнительныеПараметры) Экспорт
	
	ФормаОбработки = ДополнительныеПараметры.ФормаОбработки;
	
	ФормаОбработки.Объект.КаталогИнструментов=Объект.КаталогИнструментов;
	ФормаОбработки.Объект.КаталогФич = Объект.СтруктураДляЗагрузки;
	
	ФормаОбработки.ЗагрузитьФичи();
	СкопироватьДеревоФич(ФормаОбработки.Объект);
	ФормаОбработки.Закрыть();

КонецПроцедуры

&НаКлиенте
Процедура СохранитьИзменения(Команда)
	//TODO
	//Здесь будет сохранение изменений в хранилище
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьПоШаблону(Команда)
	//TODO
	//Здесь будет заполнение по шаблону в зависимости от текущей строки.
	//Подумать, может сделать выбор шаблона
КонецПроцедуры

&НаКлиенте
Процедура ДеревоРедактораПриНачалеРедактирования(Элемент, НоваяСтрока, Копирование)
	//TODO
	//Здесь будет редактирование, в зависимости от установленного параметра.
	//Когда редактировать в тексте = истина, тогда открывается отдельное окно для редактирования
	//Когда редактировать в тексте = ложь, тогда редактирование производится в строке  
	//Подумать, а может не надо?
	//Редактировать в отдельном окне, потом при окончании редактирования разбивать на структуру дерева
КонецПроцедуры

&НаСервереБезКонтекста
Функция РазложитьСтрокуВМассивПодстрок(Знач Строка, Знач Разделитель = ",", Знач ПропускатьПустыеСтроки = Неопределено) Экспорт
	
	Результат = Новый Массив;
	
	// для обеспечения обратной совместимости
	Если ПропускатьПустыеСтроки = Неопределено Тогда
		ПропускатьПустыеСтроки = ?(Разделитель = " ", Истина, Ложь);
		Если ПустаяСтрока(Строка) Тогда 
			Если Разделитель = " " Тогда
				Результат.Добавить("");
			КонецЕсли;
			Возврат Результат;
		КонецЕсли;
	КонецЕсли;
	//
	
	Позиция = Найти(Строка, Разделитель);
	Пока Позиция > 0 Цикл
		Подстрока = Лев(Строка, Позиция - 1);
		Если Не ПропускатьПустыеСтроки Или Не ПустаяСтрока(Подстрока) Тогда
			Результат.Добавить(Подстрока);
		КонецЕсли;
		Строка = Сред(Строка, Позиция + СтрДлина(Разделитель));
		Позиция = Найти(Строка, Разделитель);
	КонецЦикла;
	
	Если Не ПропускатьПустыеСтроки Или Не ПустаяСтрока(Строка) Тогда
		Результат.Добавить(Строка);
	КонецЕсли;
	
	Возврат Результат;
	
КонецФункции 

&НаСервереБезКонтекста 
Функция ПолучитьРежимМодальностиКонфигурации()
	Возврат Метаданные.РежимИспользованияМодальности = Метаданные.СвойстваОбъектов.РежимИспользованияМодальности.Использовать;
КонецФункции

&НаСервереБезКонтекста
Функция УзнатьЕстьПоддержкаНемодальныхФорм()
	СистемнаяИнформация = Новый СистемнаяИнформация;
	Массив1 = РазложитьСтрокуВМассивПодстрок(СистемнаяИнформация.ВерсияПриложения,".");
	Массив2 = РазложитьСтрокуВМассивПодстрок("8.3.3.641",".");
	
	Версия1БольшеИлиРавно = Истина;
	Для Ккк = 0 По Массив1.Количество()-1 Цикл
		Элем1 = Массив1.Получить(Ккк);
		Элем2 = Массив2.Получить(Ккк);
		
		Если Число(Элем2) > Число(Элем1) Тогда
			Версия1БольшеИлиРавно = Ложь;
		КонецЕсли;	 
	КонецЦикла;
	
	Возврат Версия1БольшеИлиРавно;
КонецФункции

&НаСервереБезКонтекста
Функция УзнатьЕстьПоддержкаАсинхронныхВызовов()
	СистемнаяИнформация = Новый СистемнаяИнформация;
	Массив1 = РазложитьСтрокуВМассивПодстрок(СистемнаяИнформация.ВерсияПриложения,".");
	Массив2 = РазложитьСтрокуВМассивПодстрок("8.3.5.1383",".");
	
	Версия1БольшеИлиРавно = Истина;
	Для Ккк = 0 По Массив1.Количество()-1 Цикл
		Элем1 = Массив1.Получить(Ккк);
		Элем2 = Массив2.Получить(Ккк);
		
		Если Число(Элем2) > Число(Элем1) Тогда
			Версия1БольшеИлиРавно = Ложь;
		КонецЕсли;	 
	КонецЦикла;
	
	
	Рез = Версия1БольшеИлиРавно И Вычислить("Метаданные.РежимИспользованияСинхронныхВызововРасширенийИВнешнихКомпонент <> Метаданные.СвойстваОбъектов.РежимИспользованияСинхронныхВызововРасширенийИВнешнихКомпонент.Использовать");
	
	Возврат Рез;
КонецФункции

&НаКлиенте
Функция УзнатьЕстьПоддержкаНемодальныхФормКлиент() Экспорт
	Возврат УзнатьЕстьПоддержкаНемодальныхФорм();
КонецФункции

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	//Вставить содержимое обработчика
	ЕстьПоддержкаНемодальныхФорм    = УзнатьЕстьПоддержкаНемодальныхФорм();
	ЕстьПоддержкаАсинхронныхВызовов = УзнатьЕстьПоддержкаАсинхронныхВызовов();
//	ИмяОбработки = РеквизитФормыВЗначение("Объект").Метаданные().ПолноеИмя();
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьВыборФайла(ВыбранныеФайлы,ДополнительныеПараметры) Экспорт
	ПустьСохранения=ДополнительныеПараметры.Путь;
	Если ВыбранныеФайлы = Неопределено Тогда
		Возврат;
	КонецЕсли;	
	Объект[ПустьСохранения]=ВыбранныеФайлы[0];
КонецПроцедуры

&НаКлиенте
Процедура ПутьКVanessaBehaviorНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	Режим = РежимДиалогаВыбораФайла.Открытие;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.Заголовок = "Выберите путь к обработке Vanessa Behavior ";
	ДиалогОткрытияФайла.Фильтр = "Файл (*.epf)|*.epf";
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОписаниеОповещения = Вычислить("Новый ОписаниеОповещения(""ОбработатьВыборФайла"", ЭтаФорма,Новый Структура(""Путь"", ""ПутьКVanessaBehavior""))");
		Выполнить("ДиалогОткрытияФайла.Показать(ОписаниеОповещения)");
	Иначе	
		Если ДиалогОткрытияФайла.Выбрать() Тогда
			Объект.ПутьКVanessaBehavior = ДиалогОткрытияФайла.ПолноеИмяФайла;
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;  
КонецПроцедуры

&НаКлиенте
Процедура КаталогИнструментовНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.Заголовок = "Выберите путь к каталогу инструментов ";
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОписаниеОповещения = Вычислить("Новый ОписаниеОповещения(""ОбработатьВыборФайла"", ЭтаФорма,Новый Структура(""Путь"", ""КаталогИнструментов""))");
		Выполнить("ДиалогОткрытияФайла.Показать(ОписаниеОповещения)");
	Иначе	
		Если ДиалогОткрытияФайла.Выбрать() Тогда
			Объект.КаталогИнструментов = ДиалогОткрытияФайла.Каталог;
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;  
КонецПроцедуры

&НаКлиенте
Процедура ПутьКCommonsНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.Заголовок = "Выберите путь к каталогу инструментов ";
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОписаниеОповещения = Вычислить("Новый ОписаниеОповещения(""ОбработатьВыборФайла"", ЭтаФорма,Новый Структура(""Путь"", ""ПутьКCommons""))");
		Выполнить("ДиалогОткрытияФайла.Показать(ОписаниеОповещения)");
	Иначе	
		Если ДиалогОткрытияФайла.Выбрать() Тогда
			Объект.ПутьКCommons = ДиалогОткрытияФайла.Каталог;
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;  
КонецПроцедуры

&НаКлиенте
Процедура КаталогBDDEditorНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	// Вставить содержимое обработчика.
	Режим = РежимДиалогаВыбораФайла.ВыборКаталога;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.Заголовок = "Выберите путь к каталогу инструментов ";
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОписаниеОповещения = Вычислить("Новый ОписаниеОповещения(""ОбработатьВыборФайла"", ЭтаФорма,Новый Структура(""Путь"", ""КаталогBDDEditor""))");
		Выполнить("ДиалогОткрытияФайла.Показать(ОписаниеОповещения)");
	Иначе	
		Если ДиалогОткрытияФайла.Выбрать() Тогда
			Объект.КаталогBDDEditor = ДиалогОткрытияФайла.Каталог;
		Иначе
			Возврат;
		КонецЕсли;
	КонецЕсли;  
КонецПроцедуры

&НаСервере
Процедура ВосстановитьНастройки() Экспорт
	Если Объект.РежимСамотестирования Тогда
		Возврат;
	КонецЕсли;  
	
	Настройки = ХранилищеОбщихНастроек.Загрузить("VanessaBDDEditor");
	Если ТипЗнч(Настройки) = Тип("Структура") Тогда
		
		Настройки.Свойство("ПутьКVanessaBehavior", Объект.ПутьКVanessaBehavior);
		Настройки.Свойство("ПутьКCommons",Объект.ПутьКCommons);
		Настройки.Свойство("КаталогИнструментов", Объект.КаталогИнструментов);
		Настройки.Свойство("КаталогBDDEditor", Объект.КаталогBDDEditor);
		
		Настройки.Свойство("ПоказыватьРасшифровку", Объект.ПоказыватьРасшифровку);
		Настройки.Свойство("СтруктураДляЗагрузки", Объект.СтруктураДляЗагрузки);
		ТекущаяСтраница="";
		Если Настройки.Свойство("ТекущаяСтраница",ТекущаяСтраница) Тогда
			ЭтаФорма.Элементы.ГруппаОбщая.ТекущаяСтраница=ЭтаФорма.Элементы[ТекущаяСтраница];
		КонецЕсли;	
		
	КонецЕсли;
	
	Настройки = ХранилищеОбщихНастроек.Загрузить("VanessaEpics");
	Если ТипЗнч(Настройки) = Тип("Структура") Тогда
		Настройки.Свойство("gitrepos", Объект.Репозиторий);
		АктивироватьСтраницыРаботыСРепозиторием();
	Иначе	
		АктивироватьСтраницыНастройки();
	КонецЕсли;

КонецПроцедуры

&НаСервере
Процедура СохранитьНастройки() Экспорт
	Если Объект.РежимСамотестирования Тогда
		Возврат;
	КонецЕсли;  
	
	Настройки = Новый Структура;
	Настройки.Вставить("ПутьКVanessaBehavior", Объект.ПутьКVanessaBehavior);
	Настройки.Вставить("ПутьКCommons",Объект.ПутьКCommons);
	Настройки.Вставить("КаталогИнструментов", Объект.КаталогИнструментов);
	Настройки.Вставить("КаталогBDDEditor", Объект.КаталогBDDEditor);
	
	Настройки.Вставить("ПоказыватьРасшифровку", Объект.ПоказыватьРасшифровку);
	Настройки.Вставить("СтруктураДляЗагрузки", Объект.СтруктураДляЗагрузки);
	Настройки.Вставить("ТекущаяСтраница",ЭтаФорма.Элементы.ГруппаОбщая.ТекущаяСтраница.Имя);
	
	ХранилищеОбщихНастроек.Сохранить("VanessaBDDEditor",, Настройки);
КонецПроцедуры

&НаКлиенте
Процедура НастроитьВидимостьИДоступность()
	ЭтаФорма.Элементы.ТЗСбораТребованийРасшифровка.Видимость=Объект.ПоказыватьРасшифровку;
КонецПроцедуры	

&НаКлиенте
Процедура ПриОткрытии(Отказ)
	//Вставить содержимое обработчика
	ВосстановитьНастройки();
	НастроитьВидимостьИДоступность();
	Если ЗначениеЗаполнено(Объект.СтруктураДляЗагрузки) Тогда
		//ПолучитьСтруктуруКаталогов("СписокКомпонент");
		ПолучитьСтруктуруКаталогов("ОбъемПроекта");
		ЗаполнитьТЗСбораТребованийИзПапкиТемп();	
	КонецЕсли;	
	ЗаполнитьКонтекстноеМеню();
КонецПроцедуры

&НаКлиенте
Процедура ПриЗакрытии()
	//Вставить содержимое обработчика
	СохранитьНастройки();
КонецПроцедуры

#Область КонтекстноеМеню

&НаСервере 
Процедура ЗаполнитьКонтекстноеМеню()
	Пункт1=Элементы.Добавить("ДеревоРедактораКонтекстноеМенюПунктВыполнитьСценарий", Тип("КнопкаФормы"), Элементы.ДеревоРедактора.КонтекстноеМеню);
	Пункт1.Заголовок="Открыть feature файл в редакторе";
	Пункт1.ИмяКоманды="ОткрытьФичаФайлВРедакторе";
	
	Пункт2=Элементы.Добавить("ДеревоРедактораКонтекстноеМенюПунктОткрытьФичаФайл", Тип("КнопкаФормы"), Элементы.ДеревоРедактора.КонтекстноеМеню);
	Пункт2.Заголовок="Открыть feature файл в Notepad++";
	Пункт2.ИмяКоманды="ОткрытьФичаФайлВNotepad";
	
КонецПроцедуры

&НаКлиенте
Процедура ОбработатьЗапускПриложения(КодВозврата,ДополнительныеПараметры) Экспорт
КонецПроцедуры

&НаКлиенте
Функция НайтиСтрокуФичиЧерезРодителя(Стр)
	СтрокаДерева = Стр;
	Пока Истина Цикл
		СтрокаДерева = СтрокаДерева.ПолучитьРодителя();
		Если СтрокаДерева = Неопределено Тогда
			Возврат Неопределено;
		КонецЕсли;	 
		
		Если СтрокаДерева.Фича = Истина Тогда
			Возврат СтрокаДерева;
		КонецЕсли;	 
	КонецЦикла;
КонецФункции	

&НаКлиенте
Процедура ОткрытьФичаФайлВРедакторе(Команда)
	СтрокаФичи = Элементы.ДеревоРедактора.ТекущиеДанные;
	Если СтрокаФичи.Фича <> Истина Тогда
		СтрокаФичи = НайтиСтрокуФичиЧерезРодителя(СтрокаФичи);
		Если СтрокаФичи = Неопределено Тогда
			Сообщить("Строка с фича-файлом не найдена!");
			Возврат;
		КонецЕсли;	 
	КонецЕсли;	 
	
	ФормаОбработки = ПолучитьФорму("ВнешняяОбработка.BDDEditor.Форма.ФормаРедактора",,ЭтаФорма);
	СписокОткрытыхОкон=ПолучитьОкна();
	//Для Каждого Окно из СписокОткрытыхОкон Цикл
	//	
	//КонецЦикла;
	Если ФормаОбработки.Открыта() Тогда
		Если ФормаОбработки.ПутьКФиче<>СтрокаФичи.ПолныйПуть Тогда// И ФормаОбработки.БылиИзменения Тогда
			ФормаОбработки.ЗаписатьИзмененияВФиче();
			ФормаОбработки.ПутьКФиче=СтрокаФичи.ПолныйПуть;
			ФормаОбработки.ПолучитьТекстФичи();
			ФормаОбработки.Активизировать();
			ФормаОбработки.Открыть();
		Иначе	
			ФормаОбработки.ПутьКФиче=СтрокаФичи.ПолныйПуть;
			ФормаОбработки.ПолучитьТекстФичи();
			ФормаОбработки.Открыть();
		КонецЕсли;	
	Иначе	
		ФормаОбработки.ПутьКФиче=СтрокаФичи.ПолныйПуть;
		ФормаОбработки.Открыть();
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ОткрытьФичаФайлВNotepad(Команда)
	СтрокаФичи = Элементы.ДеревоРедактора.ТекущиеДанные;
	Если СтрокаФичи.Фича <> Истина Тогда
		СтрокаФичи = НайтиСтрокуФичиЧерезРодителя(СтрокаФичи);
		Если СтрокаФичи = Неопределено Тогда
			Сообщить("Строка с фича-файлом не найдена!");
			Возврат;
		КонецЕсли;	 
	КонецЕсли;	 
	
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОписаниеОповещения = Вычислить("Новый ОписаниеОповещения(""ОбработатьЗапускПриложения"", ЭтаФорма)");
		Выполнить("НачатьЗапускПриложения(ОписаниеОповещения,СтрокаФичи.ПолныйПуть)");
	Иначе	
		ЗапуститьПриложение(СтрокаФичи.ПолныйПуть);
	КонецЕсли;  
	
КонецПроцедуры

#КонецОбласти

&НаКлиенте
Функция УбратьЗапрещенныеСимволы(ИмяФайла) Экспорт
	ИмяФайла = СтрЗаменить(ИмяФайла,".","");
	ИмяФайла = СтрЗаменить(ИмяФайла,",","");
	ИмяФайла = СтрЗаменить(ИмяФайла,":","");
	ИмяФайла = СтрЗаменить(ИмяФайла,";","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"-","_");
	ИмяФайла = СтрЗаменить(ИмяФайла,"+","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"/","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"\","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"=","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"!","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"@","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"#","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"$","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"%","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"^","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"&","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"*","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"(","");
	ИмяФайла = СтрЗаменить(ИмяФайла,")","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"№","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"?","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"`","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"'","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"~","");
	ИмяФайла = СтрЗаменить(ИмяФайла,"<","");
	ИмяФайла = СтрЗаменить(ИмяФайла,">","");
	Возврат ИмяФайла;
КонецФункции

&НаКлиенте
Функция СделатьПервуюБуквуЗаглавной(Стр) Экспорт
	Если СтрДлина(Стр) = 0 Тогда
		Возврат Стр;
	КонецЕсли;
	
	ПерваяБуква = ВРег(Лев(Стр,1));
	
	Возврат ПерваяБуква + Сред(Стр,2);
КонецФункции

&НаКлиенте
Функция СформироватьИмяФайла(ИмяФайла) Экспорт
	ИмяФайла=УбратьЗапрещенныеСимволы(ИмяФайла);
	МассивПодстрок = РазложитьСтрокуВМассивПодстрок(ИмяФайла," ",Истина);
	НовоеИмяФайла="";
	Для Каждого Элем Из МассивПодстрок Цикл
		НовоеИмяФайла = НовоеИмяФайла + СделатьПервуюБуквуЗаглавной(Элем);
	КонецЦикла;
	Возврат НовоеИмяФайла;
КонецФункции	

&НаКлиенте
Процедура СоздатьФичаФайлыНаСервере()
	// Вставить содержимое обработчика.
	
	
КонецПроцедуры

&НаКлиенте
Функция ПоискФайлаПоИмени(ИмяФайла,ТекСтрока,ПараметрыПутей) Экспорт
	Вернуть=Новый Структура;
	НайденныеФайлы = Неопределено;
	
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		НачатьПоискФайлов(Новый ОписаниеОповещения("ПоискФайлаПоИмениЗавершение", ЭтаФорма, Новый Структура("Вернуть,ТекСтрока,ПараметрыПутей", Вернуть,ТекСтрока,ПараметрыПутей)), Объект.СтруктураДляЗагрузки,ИмяФайла,Истина);
		
	Иначе
		
		НайденныеФайлы=НайтиФайлы(Объект.СтруктураДляЗагрузки,ИмяФайла,Истина);
		Для Каждого Файлик из НайденныеФайлы Цикл
			Если Файлик.ПолноеИмя<>Неопределено Тогда
				Вернуть.Вставить("Путь",Файлик.ПолноеИмя);
			КонецЕсли;
		КонецЦикла;	
		ОбработатьНайденныеФичи(Вернуть,ТекСтрока,ПараметрыПутей);
	КонецЕсли;
КонецФункции	

&НаКлиенте
Процедура ПоискФайлаПоИмениЗавершение(НайденныеФайлы1, ДополнительныеПараметры) Экспорт
	
	Вернуть = ДополнительныеПараметры.Вернуть;
	ТекСтрока = ДополнительныеПараметры.ТекСтрока;
	ПараметрыПутей = ДополнительныеПараметры.ПараметрыПутей;
	НайденныеФайлы=НайденныеФайлы1;
	Для Каждого Файлик из НайденныеФайлы Цикл
		Если Файлик.ПолноеИмя<>Неопределено Тогда
			Вернуть.Вставить("Путь",Файлик.ПолноеИмя);
		КонецЕсли;
	КонецЦикла;	
	ОбработатьНайденныеФичи(Вернуть,ТекСтрока,ПараметрыПутей);
	//Возврат Вернуть;

КонецПроцедуры	

&НаКлиенте
Процедура ОбработатьНайденныеФичи(НайденныеФайлы,ТекСтрока,ПараметрыПутей)
	ПутьКФайлу=ПараметрыПутей.ПутьКФайлу;
	ПутьКФайлуСТемп=ПараметрыПутей.ПутьКФайлуСТемп;
	НовоеИмяФайла=ПараметрыПутей.НовоеИмяФайла;
	Стр=ПараметрыПутей.Стр;
	Если НайденныеФайлы.Количество()=0 Тогда
		Если ЗначениеЗаполнено(ТекСтрока.Компонент) Тогда
			ПолныйПуть=""+ПутьКФайлу+"\"+СокрЛП(ТекСтрока.Компонент)+"\"+СокрЛП(НовоеИмяФайла);
		Иначе
			ПолныйПуть=""+СокрЛП(ПутьКФайлуСТемп)+СокрЛП(НовоеИмяФайла);
		КонецЕсли;	
		
		АдресФайлаВоВременномХранилище = "";
		
		Шаблон=ПолучитьШаблонФичаФайла("ШаблонФичи",Стр, АдресФайлаВоВременномХранилище);
		
		Если Не ПустаяСтрока(АдресФайлаВоВременномХранилище) Тогда
			ПолучитьФайл(АдресФайлаВоВременномХранилище, ПолныйПуть,Ложь);
		КонецЕсли;
		ТекСтрока.ФичаФайл=ПолныйПуть;
	ИначеЕсли НайденныеФайлы.Количество()=1 Тогда
		ПолныйПуть=НайденныеФайлы["Путь"];
		ТекСтрока.ФичаФайл=ПолныйПуть;
	Иначе 
		ТекСтрока.ЕстьФичи=Истина;
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура СоздатьКаталогТемп(Существует, ДополнительныеПараметры) Экспорт
	
	ПутьКФайлу = ДополнительныеПараметры.ПутьКФайлу;
	ПутьКФайлуСТемп = ДополнительныеПараметры.ПутьКФайлуСТемп;
	
	
	Если НЕ Существует Тогда
		НачатьСозданиеКаталога(Новый ОписаниеОповещения("СоздатьФичаФайлыЗавершение", ЭтаФорма, Новый Структура("ПутьКФайлу, ПутьКФайлуСТемп", ПутьКФайлу, ПутьКФайлуСТемп)), ПутьКФайлуСТемп);
		Возврат;
	КонецЕсли;	
	СоздатьФичаФайлыФрагмент(ПутьКФайлу, ПутьКФайлуСТемп);

КонецПроцедуры

&НаКлиенте
Процедура СоздатьФичаФайлыЗавершение(ПутьКФайлуСТемп, ДополнительныеПараметры) Экспорт
	
	ПутьКФайлу = ДополнительныеПараметры.ПутьКФайлу;
	ПутьКФайлуСТемп = ДополнительныеПараметры.ПутьКФайлуСТемп;
	
	СоздатьФичаФайлыФрагмент(ПутьКФайлу, ПутьКФайлуСТемп);

КонецПроцедуры

&НаКлиенте
Процедура ПроверитьНаличиеПапкиТемп(Файл, ДополнительныеПараметры) Экспорт
	
	ПутьКФайлу = ДополнительныеПараметры.ПутьКФайлу;
	ПутьКФайлуСТемп = ДополнительныеПараметры.ПутьКФайлуСТемп;
	ДальнейшаяПроцедура = ДополнительныеПараметры.ДальнейшаяПроцедура;
	
	Темп=Файл;
	Темп.НачатьПроверкуСуществования(Новый ОписаниеОповещения(ДальнейшаяПроцедура, ЭтаФорма, ДополнительныеПараметры));

КонецПроцедуры

&НаКлиенте
Процедура СоздатьФичаФайлы(Команда)
	Если НЕ ЗначениеЗаполнено(ЭтаФорма.Объект.СтруктураДляЗагрузки) Тогда
		Сообщить("Не заполнен путь к структуре!");
		Возврат;
	КонецЕсли;	
	ПутьКФайлу = Объект.СтруктураДляЗагрузки;
	ПутьКФайлуСТемп=Объект.СтруктураДляЗагрузки+"\Drafts";
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		Темп = Новый Файл();
		Темп.НачатьИнициализацию(Новый ОписаниеОповещения("ПроверитьНаличиеПапкиТемп", ЭтаФорма, Новый Структура("ПутьКФайлу, ПутьКФайлуСТемп, ДальнейшаяПроцедура", ПутьКФайлу, ПутьКФайлуСТемп,"СоздатьКаталогТемп")), ПутьКФайлуСТемп);
	Иначе
		Темп=Новый Файл(ПутьКФайлуСТемп);
		Если НЕ Темп.Существует() Тогда
			СоздатьКаталог(ПутьКФайлуСТемп);
		КонецЕсли;	
		ПутьКФайлуСТемп=ПутьКФайлуСТемп;//+"\";
		СоздатьФичаФайлыФрагмент(ПутьКФайлу, ПутьКФайлуСТемп);
		
	КонецЕсли;	

КонецПроцедуры

&НаКлиенте
Процедура СоздатьФичаФайлыФрагмент(Знач ПутьКФайлу, ПутьКФайлуСТемп) Экспорт
	
	Перем АдресФайлаВоВременномХранилище, ИмяФайла, НайденныеФайлы, НовоеИмяФайла, ПолныйПуть, Стр, ТекСтрока, Шаблон;
	
	ПутьКФайлуСТемп=ПутьКФайлуСТемп+"\";
	
	Для Стр=0 По ТЗСбораТребований.Количество()-1 Цикл
		ТекСтрока=ТЗСбораТребований.Получить(Стр);
		Если ЗначениеЗаполнено(ТекСтрока.ФичаФайл) Тогда
			Продолжить;
		КонецЕсли;
		Если НЕ ЗначениеЗаполнено(ТекСтрока.Функционал) Тогда
			Продолжить;
		КонецЕсли;	
		ИмяФайла = СокрЛП(ТекСтрока.Функционал);
		НовоеИмяФайла="";
		НовоеИмяФайла = СформироватьИмяФайла(ИмяФайла);
		НовоеИмяФайла=НовоеИмяФайла+".feature";
		НайденныеФайлы=Новый Структура;
		ПараметрыПутей=Новый Структура;
		ПараметрыПутей.Вставить("ПутьКФайлу",ПутьКФайлу);
		ПараметрыПутей.Вставить("ПутьКФайлуСТемп",ПутьКФайлуСТемп);
		ПараметрыПутей.Вставить("НовоеИмяФайла",НовоеИмяФайла);
		ПараметрыПутей.Вставить("Стр",Стр);
		НайденныеФайлы=ПоискФайлаПоИмени(НовоеИмяФайла,ТекСтрока,ПараметрыПутей);
		
	КонецЦикла;

КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьИзТемпа(Команда) Экспорт
	// Вставить содержимое обработчика.
	Если НЕ ЗначениеЗаполнено(ЭтаФорма.Объект.СтруктураДляЗагрузки) Тогда
		Сообщить("Не заполнен путь к структуре!");
		Возврат;
	КонецЕсли;	
	ЗаполнитьТЗСбораТребованийИзПапкиТемп(Истина);	
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьТЗСбораТребованийИзПапкиТемп(Обновлять=Ложь) Экспорт
	ПутьКФайлу = Объект.СтруктураДляЗагрузки;
	ПутьКФайлуСТемп=Объект.СтруктураДляЗагрузки+"\Drafts";
	ТЗСбораТребований.Очистить();
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		Темп = Новый Файл();
		Темп.НачатьИнициализацию(Новый ОписаниеОповещения("ПроверитьНаличиеПапкиТемп", ЭтаФорма, Новый Структура("ПутьКФайлу, ПутьКФайлуСТемп, ДальнейшаяПроцедура,Обновлять", ПутьКФайлу, ПутьКФайлуСТемп,"ЗаполнитьФичамиИзКаталога",Обновлять)), ПутьКФайлуСТемп);
	Иначе
		Темп=Новый Файл(ПутьКФайлуСТемп);
		Если НЕ Темп.Существует() Тогда
			СоздатьКаталог(ПутьКФайлуСТемп);
			Возврат;
		КонецЕсли;	
		ПутьКФайлуСТемп=ПутьКФайлуСТемп+"\";
		НайденныеФайлы=НайтиФайлы(ПутьКФайлуСТемп,"*.feature",Ложь);
		ДополнительныеПараметры=Новый Структура("Обновлять",Обновлять);
		ЗаполнитьФичаФайламиИзВременногоКаталога(НайденныеФайлы, ДополнительныеПараметры);
	КонецЕсли;	
	
КонецПроцедуры	

&НаКлиенте
Процедура ЗаполнитьФичамиИзКаталога(Существует, ДополнительныеПараметры) Экспорт
	
	ПутьКФайлуСТемп = ДополнительныеПараметры.ПутьКФайлуСТемп;
	
	Если Существует Тогда 
		НачатьПоискФайлов(Новый ОписаниеОповещения("ЗаполнитьФичаФайламиИзВременногоКаталога",ЭтаФорма,ДополнительныеПараметры),ПутьКФайлуСТемп,"*.feature",Ложь);
//		НачатьПолучениеФайлов(Новый ОписаниеОповещения("ЗаполнитьФичаФайламиИзВременногоКаталога", ЭтаФорма, Новый Структура("ПутьКФайлу, ПутьКФайлуСТемп", ПутьКФайлу, ПутьКФайлуСТемп)), ПутьКФайлуСТемп);
		Возврат;
	КонецЕсли;	
	
КонецПроцедуры


&НаКлиенте
Процедура ЗаполнитьФичаФайламиИзВременногоКаталога(НайденныеФайлы, ДополнительныеПараметры) Экспорт
	Обновлять=ДополнительныеПараметры.Обновлять;
	Для Каждого Файл из НайденныеФайлы Цикл
		НашлиСТроки=ЭтотОбъект.ТЗСбораТребований.НайтиСтроки(Новый Структура("ФичаФайл",Файл.ПолноеИмя));
		Если НашлиСтроки.Количество()<>0 и НЕ Обновлять Тогда
			Продолжить;
		ИначеЕсли НашлиСтроки.Количество()<>0 и Обновлять Тогда
			Строка= НашлиСтроки[0];
		Иначе
			Строка=ЭтотОбъект.ТЗСбораТребований.Добавить();
		КонецЕсли;	
		Строка.ФичаФайл=Файл.ПолноеИмя;
		Строка.Функционал=Файл.ИмяБезРасширения;
		СтруктураФичи=РаспарситьФункционалОднойФичи(Файл.ПолноеИмя);
		Строка.Функционал=СтруктураФичи["Функционал"];
		Строка.Роль=СтруктураФичи["Роль"];
		Строка.Описание=СтруктураФичи["Описание"];
		Строка.Цель=СтруктураФичи["Цель"];
		Строка.КоличествоСценариев=СтруктураФичи["КоличествоСценариев"];
	КонецЦикла;	
	
КонецПроцедуры	

&НаКлиенте
Функция СоздатьСтруктуруФичаФайла()
	СтруктураФичи=Новый Структура;
	СтруктураФичи.Вставить("Функционал");
	СтруктураФичи.Вставить("Роль");
	СтруктураФичи.Вставить("Описание");
	СтруктураФичи.Вставить("Цель");
	СтруктураФичи.Вставить("КоличествоСценариев");
	Возврат СтруктураФичи;
КонецФункции	

&НаКлиенте
Функция РаспарситьФункционалОднойФичи(ПутьКФиче) Экспорт
	
	СтруктураФичи=СоздатьСтруктуруФичаФайла();
	ИмяФайлаФичи = ПутьКФиче;
	ТекстФичи="";
	Текст = Новый ЧтениеТекста;
	//Текст.Открыть(ИмяФайлаФичи,"UTF-8");
	//Стр=Текст.Прочитать();
	//СтрокаФункционала=Найти(Стр,"Функционал:")+СтрДлина("Функционал:");
	//КонецСтрокиФункционала=Найти(Сред(Стр,СтрокаФункционала),Символы.ПС);
	//Функционал=СокрЛП(Сред(Стр,СтрокаФункционала,КонецСтрокиФункционала));
	//СтрокаКонтекст=Найти(Стр,"Контекст:");
	//Шапка=Сред(Стр,СтрокаФункционала,СтрокаКонтекст);
	//СтрокаРоль=Найти(Шапка,"Как")+СтрДлина("Как");
	//КонецСтрокиРоль=Найти(Сред(Шапка,СтрокаРоль),Символы.ПС);
	//Роль=СокрЛП(Сред(Шапка,СтрокаРоль,КонецСтрокиРоль));
	//Текст.Закрыть();
	
	Текст.Открыть(ИмяФайлаФичи,"UTF-8");
	Стр=Текст.Прочитать();
	КоличествоСценариев=СтрЧислоВхождений(Стр,"Сценарий");
	СтруктураФичи.Вставить("КоличествоСценариев",КоличествоСценариев);
	Текст.Закрыть();
	
	
	Текст.Открыть(ИмяФайлаФичи,"UTF-8");
	
	Стр = Текст.ПрочитатьСтроку();
	Пока Стр <> Неопределено Цикл // строки читаются до символа перевода строки
		Стр=СокрЛП(Стр);
		Если СтрНачинаетсяС(Стр,"Контекст") Тогда
			Прервать;
		ИначеЕсли СтрНачинаетсяС(Стр,"Функционал") Тогда
			Функционал=СокрЛП(Сред(Стр,СтрДлина("Функционал:")+1));
			СтруктураФичи.Вставить("Функционал",Функционал);
		ИначеЕсли СтрНачинаетсяС(Стр,"Как") Тогда
			Роль=СокрЛП(Сред(Стр,СтрДлина("Как")+1));
			СтруктураФичи.Вставить("Роль",Роль);
		ИначеЕсли СтрНачинаетсяС(Стр,"Я хочу") Тогда
			Описание=СокрЛП(Сред(Стр,СтрДлина("Я хочу")+1));
			//Описание=СокрЛП(Стр);
			СтруктураФичи.Вставить("Описание",Описание);
		ИначеЕсли СтрНачинаетсяС(Стр,"Чтобы") Тогда
			Цель=СокрЛП(Сред(Стр,СтрДлина("Чтобы")+1));
			//Цель=СокрЛП(Стр);
			СтруктураФичи.Вставить("Цель",Цель);
		КонецЕсли;	
		Стр = Текст.ПрочитатьСтроку();
	КонецЦикла;	
	Текст.Закрыть();
	Возврат СтруктураФичи;
		
	
КонецФункции

&НаСервере
Функция ПолучитьШаблонФичаФайла(ИмяМакета,ИндСтроки,АдресФайлаВоВременномХранилище)
	ИмяВременногоФайла = ПолучитьИмяВременногоФайла(".feature");
	ОбъектОбработки = РеквизитФормыВЗначение("Объект");
	ТЗСбора = РеквизитФормыВЗначение("ТЗСбораТребований");
	Строка=ТЗСбора.Получить(ИндСтроки);
	ТД = Новый ТекстовыйДокумент;
	Шаблон=ОбъектОбработки.ПолучитьМакет(ИмяМакета);
	ОбластьШапка=Шаблон.ПолучитьОбласть("Шапка");
	ОбластьПостоянная=Шаблон.ПолучитьОбласть("Постоянная");
	ОбластьПеременная=Шаблон.ПолучитьОбласть("Переменная");
	ОбластьПостоянная.Параметры.Функционал = СокрЛП(Строка.Функционал);
	ОбластьПостоянная.Параметры.Роль = СокрЛП(Строка.Роль);
	ОбластьПостоянная.Параметры.Описание = СокрЛП(Строка.Описание);
	ОбластьПостоянная.Параметры.Цель = СокрЛП(Строка.Цель);
	ТД.Вывести(ОбластьШапка);
	ТД.Вывести(ОбластьПостоянная);
	КоличествоСценариев=?(Строка.КоличествоСценариев=0,1,Строка.КоличествоСценариев);
	Для кк=1 по КоличествоСценариев Цикл
		ТД.Вывести(ОбластьПеременная);
	КонецЦикла;
	ТД.Записать(ИмяВременногоФайла);
	
	Файл = Новый Файл(ИмяВременногоФайла);
	Если Файл.Существует() Тогда
		ДвоичныеДанные = Новый ДвоичныеДанные(ИмяВременногоФайла);
		АдресФайлаВоВременномХранилище = ПоместитьВоВременноеХранилище(ДвоичныеДанные, УникальныйИдентификатор);
		УдалитьФайлы(ИмяВременногоФайла);
	КонецЕсли;

КонецФункции	

&НаСервере
Процедура ОбходДереваРекурсивно(Дерево,СписокДляВыбора)
	Для Каждого Строка Из Дерево.Строки Цикл
		Если Строка.Компонента<>"step_definitions" Тогда
			СписокДляВыбора.Добавить(Строка.ПолныйПуть,Строка.Компонента);
		КонецЕсли;
		Если Строка.Строки.Количество()>0 Тогда
			ОбходДереваРекурсивно(Строка,СписокДляВыбора);
		КонецЕсли;
	КонецЦикла;
КонецПроцедуры	

&НаСервере 
Функция ПолучитьСписокДляВыбораИзДерева()
	СписокДляВыбора=Новый СписокЗначений;
	//СписокКомп = РеквизитФормыВЗначение("СписокКомпонент");
	СписокКомп = РеквизитФормыВЗначение("ОбъемПроекта");
	ОбходДереваРекурсивно(СписокКомп,СписокДляВыбора);
	
	Возврат Новый Структура("СписокДляВыбора",СписокДляВыбора);
КонецФункции	

&НаКлиенте
Процедура ПослеВыбораИзМеню(ВыбранныйЭлемент, Параметры) Экспорт
    // Обработка выбранного элемента
	Если ВыбранныйЭлемент<>Неопределено Тогда
		ЭтаФорма.ТекущийЭлемент.ТекущиеДанные.Компонент=ВыбранныйЭлемент.Представление;
		ЭтаФорма.ТекущийЭлемент.ТекущиеДанные.ПутьККомпоненте=ВыбранныйЭлемент.Значение;
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ТЗСбораТребованийВыбор(Элемент, ВыбраннаяСтрока, Поле, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	Если Поле.Имя="ТЗСбораТребованийФичаФайл" Тогда
		СтандартнаяОбработка=Ложь;
		ФормаОбработки = ПолучитьФорму("ВнешняяОбработка.BDDEditor.Форма.ФормаРедактора",,ЭтаФорма);
		СписокОткрытыхОкон=ПолучитьОкна();
		//Для Каждого Окно из СписокОткрытыхОкон Цикл
		//	
		//КонецЦикла;
		Если ФормаОбработки.Открыта() Тогда
			Если ФормаОбработки.ПутьКФиче<>Элемент.ТекущиеДанные.ФичаФайл Тогда// И ФормаОбработки.БылиИзменения Тогда
				ФормаОбработки.ЗаписатьИзмененияВФиче();
				ФормаОбработки.ПутьКФиче=Элемент.ТекущиеДанные.ФичаФайл;
				ФормаОбработки.ПолучитьТекстФичи();
				ФормаОбработки.Активизировать();
				ФормаОбработки.Открыть();
			Иначе	
				ФормаОбработки.ПутьКФиче=Элемент.ТекущиеДанные.ФичаФайл;
				ФормаОбработки.ПолучитьТекстФичи();
				ФормаОбработки.Открыть();
			КонецЕсли;	
		Иначе	
			ФормаОбработки.ПутьКФиче=Элемент.ТекущиеДанные.ФичаФайл;
			ФормаОбработки.Открыть();
		КонецЕсли;	
	//	ОткрытьФорму(Объект.ИмяОбработки + ".Форма.ФормаРедактора");
	ИначеЕсли Поле.Имя = "ТЗСбораТребованийКомпонент" Тогда
		СтандартнаяОбработка=Ложь;
		СписокВыбораКомпонент=Новый СписокЗначений;
		СписокВыбораКомпонент=ПолучитьСписокДляВыбораИзДерева()["СписокДляВыбора"];
		Если СписокВыбораКомпонент.Количество()>0 Тогда
			РежимМодальности=ПолучитьРежимМодальностиКонфигурации();
			Если НЕ РежимМодальности Тогда		
				Оповещение = Новый ОписаниеОповещения("ПослеВыбораИзМеню",ЭтотОбъект, );
				ПоказатьВыборИзМеню(Оповещение, СписокВыбораКомпонент,);
			Иначе
				ВыборКомпоненты=ВыбратьИзМеню(СписокВыбораКомпонент);
				Если ВыборКомпоненты<>Неопределено Тогда
					Элемент.ТекущиеДанные.Компонент=ВыборКомпоненты.Представление;
					Элемент.ТекущиеДанные.ПутьККомпоненте=ВыборКомпоненты.Значение;
				КонецЕсли;	
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Функция ЗаполнитьДеревоКомпонент(ПутьКаталога,МассивСпискаКомпонент,Уровень)
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		НайденныеФайлы=Новый Структура;
		//Дописать	
	Иначе
    	НайденныеФайлы = НайтиФайлы(ПутьКаталога,"*.*",Истина);
	КонецЕсли;
	Для каждого Файл из НайденныеФайлы цикл
		Если Файл.ЭтоКаталог() И НЕ Файл.ПолучитьНевидимость() тогда
			СтруткураФайла = Новый Структура;
			СтруткураФайла.Вставить("Уровень",Уровень);
			СтруткураФайла.Вставить("Каталог",Истина);
			СтруткураФайла.Вставить("Имя",Файл.Имя);
			СтруткураФайла.Вставить("ПолныйПуть",Файл.ПолноеИмя);
			МассивСпискаКомпонент.Добавить(СтруткураФайла);
			Уровень=Уровень+1;
            ЗаполнитьДеревоКомпонент(ПутьКаталога+"\"+Файл.Имя,МассивСпискаКомпонент,Уровень);
			Уровень=Уровень-1;
        КонецЕсли;
    КонецЦикла;
КонецФункции

&НаКлиенте
Процедура ПолучитьСтруктуруКаталогов(ДеревоЗаполнения)
	ПутьККаталогам=Объект.СтруктураДляЗагрузки;
	ЭтаФорма[ДеревоЗаполнения].ПолучитьЭлементы().Очистить();
	МассивСпискаКомпонент=Новый Массив;
	//	Путь = Новый Файл(ПутьККаталогам);
	
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		//Путь = Новый Файл();
		//Путь.НачатьИнициализацию(Новый ОписаниеОповещения("ПолучитьСтруктуруКаталоговЗавершение", ЭтаФорма, Новый Структура("МассивСпискаКомпонент, ПутьККаталогам", МассивСпискаКомпонент, ПутьККаталогам)), ПутьККаталогам);
		ОписаниеОповещения = Новый ОписаниеОповещения("ПолучитьСтруктуруКаталоговЗавершение",ЭтотОбъект,Новый Структура("МассивСпискаКомпонент, ПутьККаталогам, ДеревоЗаполнения", МассивСпискаКомпонент, ПутьККаталогам, ДеревоЗаполнения));//,"ОбработкаФайловОшибка",ЭтотОбъект);
		НачатьПоискФайлов(ОписаниеОповещения,ПутьККаталогам,"*.*",истина);
	Иначе	
		
		Путь = Новый Файл(ПутьККаталогам);
    	НайденныеФайлы = НайтиФайлы(ПутьККаталогам,"*.*",Истина);
		ДополнительныеПараметры=Новый Структура("МассивСпискаКомпонент, ПутьККаталогам, ДеревоЗаполнения", МассивСпискаКомпонент, ПутьККаталогам, ДеревоЗаполнения);
		ПолучитьСтруктуруКаталоговЗавершение(НайденныеФайлы, ДополнительныеПараметры)
	КонецЕсли;	
	
КонецПроцедуры

&НаКлиенте
Процедура ПолучитьСтруктуруКаталоговЗавершение(НайденныеФайлы, ДополнительныеПараметры) Экспорт
	
	МассивСпискаКомпонент = ДополнительныеПараметры.МассивСпискаКомпонент;
	ПутьККаталогам = ДополнительныеПараметры.ПутьККаталогам;
	ДеревоЗаполнения = ДополнительныеПараметры.ДеревоЗаполнения;
	Контекст = Новый Структура;
	Контекст.Вставить("Индекс",-1);
	Контекст.Вставить("Файлы",НайденныеФайлы);
	Контекст.Вставить("ДеревоЗаполнения",ДеревоЗаполнения);
	ЦиклОбработкиФайлов(Контекст);

КонецПроцедуры

&НаКлиенте
Процедура ЦиклОбработкиФайлов(Контекст) Экспорт
	Если Контекст.Индекс + 1 >= Контекст.Файлы.Количество() Тогда
//		ВыполнитьОбработкуОповещения(Контекст.оповещение,Истина);
		Возврат;
	КонецЕсли;
	
	Контекст.Индекс = Контекст.Индекс + 1;
	ОповещениеПроверки = Новый ОписаниеОповещения("ПослеПроверкиЭтоКаталог",ЭтотОбъект,Контекст);
	Контекст.Файлы[Контекст.Индекс].НачатьПроверкуЭтоКаталог(ОповещениеПроверки);
	
		
КонецПроцедуры

&НаКлиенте
Процедура ПослеПроверкиЭтоКаталог(ЭтоКаталог,Контекст) экспорт
	
	
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОповещениеПроверки = Новый ОписаниеОповещения("ПослеПолученияВремениИзменения",ЭтотОбъект,Новый Структура("Контекст,ЭтоКаталог",Контекст,ЭтоКаталог));
		Контекст.Файлы[Контекст.Индекс].НачатьПолучениеВремениИзменения(ОповещениеПроверки);
	Иначе
		ВремяИзменения=Контекст.файлы[Контекст.Индекс].ПолучитьВремяИзменения();
		СтруктураДанных=Новый Структура("Путь,Имя,ПолноеИмя",Контекст.файлы[Контекст.Индекс].Путь,Контекст.файлы[Контекст.Индекс].Имя,Контекст.файлы[Контекст.Индекс].ПолноеИмя);
		ДобавитьВДерево(СтруктураДанных,ЭтоКаталог,Контекст.ДеревоЗаполнения,ВремяИзменения);
		ЦиклОбработкиФайлов(Контекст);
	КонецЕсли;	
КонецПроцедуры

&НаКлиенте
Процедура ПослеПолученияВремениИзменения(ВремяИзменения,ДополнительныеПараметры) Экспорт
	Контекст=ДополнительныеПараметры.Контекст;
	ЭтоКаталог=ДополнительныеПараметры.ЭтоКаталог;
	СтруктураДанных=Новый Структура("Путь,Имя,ПолноеИмя",Контекст.файлы[Контекст.Индекс].Путь,Контекст.файлы[Контекст.Индекс].Имя,Контекст.файлы[Контекст.Индекс].ПолноеИмя);
	ДобавитьВДерево(СтруктураДанных,ЭтоКаталог,Контекст.ДеревоЗаполнения,ВремяИзменения);
	ЦиклОбработкиФайлов(Контекст);
	
КонецПроцедуры	

&НаСервере
Процедура ДобавитьВДерево(СтруктураДанных,ЭтоКаталог,ДеревоЗаполнения,ВремяИзменения)
	Путь=СтруктураДанных.Путь;
	Имя=СтруктураДанных.Имя;
	ПолноеИмя=СтруктураДанных.ПолноеИмя;
	СписокКомпонент1 = РеквизитФормыВЗначение(СокрЛП(ДеревоЗаполнения));
	Стр = СписокКомпонент1.Строки.Найти(Путь,"ПолныйПуть",истина);
	Если Стр = Неопределено Тогда
		Ветка = СписокКомпонент1.Строки.Добавить();
		Ветка.Компонента = "feature";
		Ветка.ПолныйПуть = Путь;
		Ветка.Имя = "feature";
		Если СписокКомпонент1.Колонки.Найти("КоличествоФичаФайлов")<>Неопределено Тогда
			МассивКоличество=НайтиФайлы(Ветка.ПолныйПуть,"*.feature",Истина);
			Ветка.КоличествоФичаФайлов=МассивКоличество.Количество();
		КонецЕсли;
		Если СписокКомпонент1.Колонки.Найти("ПоследнееОбновление")<>Неопределено Тогда
			Ветка.ПоследнееОбновление=ВремяИзменения;
		КонецЕсли;
	Иначе
		Ветка = Стр;
	КонецЕсли;
	Стр = Ветка.строки.Найти(Имя,"Компонента",Истина);
	Если Стр = Неопределено Тогда
		Если ЭтоКаталог Тогда
			Ветка1 = ветка.Строки.Добавить();
			Ветка1.Компонента = Имя;
			Ветка1.ПолныйПуть = ПолноеИмя + ?(ЭтоКаталог,"\","");
			Ветка1.Имя = Имя;
			Если СписокКомпонент1.Колонки.Найти("КоличествоФичаФайлов")<>Неопределено Тогда
				МассивКоличество=НайтиФайлы(Ветка1.ПолныйПуть,"*.feature",Истина);
				Ветка1.КоличествоФичаФайлов=МассивКоличество.Количество();
			КонецЕсли;
			Если СписокКомпонент1.Колонки.Найти("ПоследнееОбновление")<>Неопределено Тогда
				Ветка1.ПоследнееОбновление=ВремяИзменения;
			КонецЕсли;
		КонецЕсли;
	КонецЕсли;

	ЗначениеВРеквизитФормы(СписокКомпонент1,СокрЛП(ДеревоЗаполнения));
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьДеревоЗначенийПоМассивуСервер(МассивСпискаКомпонент,СтруктураПараметров)
	СписокКомп = РеквизитФормыВЗначение("СписокКомпонент");
	
	СписокКомп.Строки.Очистить();
	ТекУровень = 0;
	ТекДерево = СписокКомп;
	
	Для каждого Элем Из МассивСпискаКомпонент Цикл
		Если Элем.Имя="step_definitions" Тогда
			Продолжить;
		КонецЕсли;	
		Если Элем.Уровень > ТекУровень Тогда
			ТекУровень = Элем.Уровень;
			НовСтр     = ТекДерево.Строки.Добавить();
			ТекДерево = НовСтр;
		ИначеЕсли Элем.Уровень < ТекУровень Тогда
			Разн = ТекУровень - Элем.Уровень;
			Для Ккк = 1 По Разн Цикл
				НовСтр = НовСтр.Родитель;
			КонецЦикла;
			НовСтр     = НовСтр.Родитель.Строки.Добавить();
			ТекУровень = Элем.Уровень;
			ТекДерево = НовСтр;
		Иначе	
			НовСтр     = ТекДерево.Родитель.Строки.Добавить();
		КонецЕсли;  
		
		НовСтр.Компонента = Элем.Имя;
		НовСтр.ПолныйПуть = Элем.ПолныйПуть;
		НовСтр.Имя        = Элем.Имя;
	КонецЦикла;
	
	ЗначениеВРеквизитФормы(СписокКомп,"СписокКомпонент");
КонецПроцедуры

&НаКлиенте
Процедура ЗаполнитьСписок(Команда)
	 // Вставить содержимое обработчика.
	//ПолучитьСтруктуруКаталогов("СписокКомпонент");
	ПолучитьСтруктуруКаталогов("ОбъемПроекта");
КонецПроцедуры


#Область Эпик

&НаСервере
Процедура СохранитьНастройкиВХранилище()
	Если Объект.РежимСамотестирования Тогда
		Возврат;
	КонецЕсли;  
	
	Настройки = Новый Структура;
	Настройки.Вставить("gitrepos", Объект.Репозиторий);
	
	ХранилищеОбщихНастроек.Сохранить("VanessaEpics",, Настройки);
	
КонецПроцедуры

&НаКлиенте
Процедура СохранитьНастройкиРепозитория(Команда)
	// Вставить содержимое обработчика.
	СохранитьНастройкиВХранилище();

КонецПроцедуры

&НаКлиенте
Процедура CохранитьЦелиИРоли(Команда)
	// Вставить содержимое обработчика.
	
КонецПроцедуры

&НаСервере
Процедура АктивироватьСтраницыНастройки()
	
	Элементы.НастройкиРепозитория.Видимость = Истина;
	Элементы.РаботаСЦелямиИКомпонентами.Видимость = Ложь;
	
КонецПроцедуры

Процедура АктивироватьСтраницыРаботыСРепозиторием()
	
	Элементы.НастройкиРепозитория.Видимость = Ложь;
	Элементы.РаботаСЦелямиИКомпонентами.Видимость = Истина;
	
КонецПроцедуры

&НаКлиенте
Процедура ПоказыватьРасшифровкуПриИзменении(Элемент)
	// Вставить содержимое обработчика.
	ЭтаФорма.Элементы.ТЗСбораТребованийРасшифровка.Видимость=Объект.ПоказыватьРасшифровку;
КонецПроцедуры

#КонецОбласти

#Область Статистика

&НаКлиенте
Процедура СобратьСтатистикуПоБизнесКомпонентам(Команда)
	// Вставить содержимое обработчика.
	ПолучитьСтруктуруКаталогов("ОбъемПроекта");
	
КонецПроцедуры

#КонецОбласти

#Область СтруктураКомпонент

&НаКлиенте
Процедура ШаблонФункциональныхТребованийНачалоВыбора(Элемент, ДанныеВыбора, СтандартнаяОбработка)
	// Вставить содержимое обработчика.
	Режим = РежимДиалогаВыбораФайла.Открытие;
	ДиалогОткрытияФайла = Новый ДиалогВыбораФайла(Режим);
	ДиалогОткрытияФайла.Заголовок = "Выберите путь к обработке Vanessa Behavior ";
	ДиалогОткрытияФайла.Фильтр = "Файл (*.yml)|*.yml";
	Если ЕстьПоддержкаАсинхронныхВызовов Тогда
		ОписаниеОповещения = Вычислить("Новый ОписаниеОповещения(""ОбработатьВыборФайла"", ЭтаФорма,Новый Структура(""Путь"", ""ШаблонФункциональныхТребований""))");
		Выполнить("ДиалогОткрытияФайла.Показать(ОписаниеОповещения)");
	Иначе	
		Если ДиалогОткрытияФайла.Выбрать() Тогда
			Объект.ШаблонФункциональныхТребований = ДиалогОткрытияФайла.ПолноеИмяФайла;
		КонецЕсли;
	КонецЕсли;  
	
КонецПроцедуры

&НаКлиенте
Процедура ЗагрузитьШаблонБК(Команда)
	// Вставить содержимое обработчика.
	ИмяФайла = СтрРазделить(Объект.ШаблонФункциональныхТребований,"\",Символы.ПС);
	ИмяФайла = ИмяФайла[ИмяФайла.Количество()-1]; 
	ИмяКомпоненты=Новый ТекстовыйДокумент;
	ИмяКомпоненты.ДобавитьСтроку("components:"+ИмяФайла);
	
	ФайлСтруктуры=Новый ЧтениеJSON;
	ФайлСтруктуры.ОткрытьФайл(Объект.ШаблонФункциональныхТребований);
	СтруктураJSON=ПрочитатьJSON(ФайлСтруктуры);
	ФайлСтруктуры.Закрыть();
	
	ПрочитатьСтруктуруJSON(СтруктураJSON);
	
	ИмяКомпоненты.ДобавитьСтроку("версия"+":"+СтруктураJSON["версия"]);
	ИмяКомпоненты.ДобавитьСтроку("описание"+":"+СтруктураJSON["описание"]);
	
	ПутьКФайлу = Объект.СтруктураДляЗагрузки+"\components.ini";
	ИмяКомпоненты.Записать(ПутьКФайлу);
	
	
КонецПроцедуры

&НаКлиенте
Процедура ПрочитатьСтруктуруJSON(СтруктураJSON) Экспорт
	Для Каждого Стр из СтруктураJSON Цикл
		Если ТипЗнч(Стр.Значение)=Тип("Массив") Тогда
			СоздатьКаталоги(Стр);
		ИначеЕсли ТипЗнч(Стр.Значение)=Тип("Структура") Тогда
			ПрочитатьСтруктуруJSON(Стр.Значение);
		КонецЕсли;	
	КонецЦикла;
	
КонецПроцедуры	

&НаКлиенте
Процедура СоздатьКаталоги(Массив) Экспорт
	Для Каждого Стр из Массив.Значение Цикл
		Если Массив.Ключ="feature" Тогда
			НовыйКаталог=Новый Файл(Объект.СтруктураДляЗагрузки+"\"+Стр);
		Иначе
			НовыйКаталог=Новый Файл(Объект.СтруктураДляЗагрузки+"\"+Массив.Ключ+"\"+Стр);
		КонецЕсли;
		
		Если НЕ НовыйКаталог.Существует() Тогда
			СоздатьКаталог(НовыйКаталог.ПолноеИмя);
		КонецЕсли;	
	КонецЦикла;
КонецПроцедуры	

#КонецОбласти


 
